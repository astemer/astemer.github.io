<!DOCTYPE html>
<html>
  <head>    
    <script>
 
    var watchProcess = null;
		var gps_coords = {lat: 0.0, long: 0.0};
		var map_coords = {topLeft_lat: 0.0, topLeft_lon: 0.0, bottomRight_lat: 0.0, bottomRight_lon: 0.0};
		var map_orient_data = {alfa: 0.0, ratioX: 1.0, ratioY: 1.0};
		var dataJsonStr = "";
		var mapOrientData = {
			vector: {angle: 0.0, dist: 0.0}, 
			vectorRatio: 0.0, 
			p1: {lat: 0.0, lon: 0.0}, 
			p2: {lat: 0.0, lon: 0.0}
		};
 
    function initiate_watchlocation() {			
			if (watchProcess == null) {
				watchProcess = navigator.geolocation.watchPosition(handle_geolocation_query, handle_errors,
			    {
						timeout: 10000,
						enableHighAccuracy: true,
						maximumAge: Infinity
					});
			}
    }
 
    function stop_watchlocation() {
		  if (watchProcess != null) {
				navigator.geolocation.clearWatch(watchProcess);
				watchProcess = null;
			}			
    }
 
    function handle_errors(error) {
            switch(error.code)
            {
                case error.PERMISSION_DENIED: alert("user did not share geolocation data");
                break;
 
                case error.POSITION_UNAVAILABLE: alert("could not detect current position");
                break;
 
                case error.TIMEOUT: alert("retrieving position timedout");
                break;
 
                default: alert("unknown error");
                break;
        		}
    }
		
    function getLocation() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(handle_geolocation_query);
			} else {
				x.innerHTML = "Geolocation is not supported by this browser.";
				x.text = "Geolocation is not supported by this browser.";
			}
		}

		function testLocation() {
			// Pairs of lat,long points:			
			var testPoints = [32.0476788,34.7729125,  32.0476788,34.7829125, 32.0376788,34.7729125,												
																							  32.0476788,35.0729125, 31.7476788,34.7729125,
																								31.7476788,35.0729125 ];    
    	for (var i=0; i<testPoints.length; i+=2) {
				console.log("Test #" + i);
				showPosition(testPoints[i], testPoints[i+1]);			
			}	
		}

		function applyLocation() {
			
			var x = document.getElementById("newLoc");
			var newLocStr = x.value;
			console.log("applyLocation: newLocStr: " + newLocStr);
			newLoc = newLocStr.split(",");
			console.log("Str: " + newLocStr);
			console.log("Arr: " + newLoc[0]);
			setPosition(parseFloat(newLoc[0]), parseFloat(newLoc[1]));		
			
			//testLocation();	
		}

		function setPosition(lat, long) {
			console.log("setPosition: lat: " + lat + ", long:" + long);
			coord_lat = lat;
			coord_long = long;
			console.log("setPosition: coord_lat: " + coord_lat + ", coord_long:" + coord_long);
			showPosition(lat, long);
		}

		function handle_geolocation_query(position) {
			console.log("===> handle_geolocation_query: lat: " + position.coords.latitude + ", long:" + position.coords.longitude);
			setPosition(position.coords.latitude, position.coords.longitude);			
    }        
		
		function showPosition(lat, long) {
			console.log("showPosition: lat: " + lat + ", long:" + long);
			var x = document.getElementById("info");
			x.value = lat +  ", " + long;
			var p = latLon_2_xy(lat, long);
			drawXonCanvas(p.x, p.y);
		}

		function drawXonCanvas(x, y) {	
			console.log("drawXonCanvas: x: " + x + ", y:" + y);
			var canvas = document.getElementById("map_canvas");		
			var context = canvas.getContext('2d');			
			context.lineWidth = 3;
			context.strokeStyle = "black";			
			var X_location_x = x;
			var X_location_y = y;
			var X_size = 20;
			//context.strokeStyle = '#00ff00';
			context.moveTo(X_location_x - X_size, X_location_y - X_size);			
			context.lineTo(X_location_x + X_size, X_location_y + X_size);
			context.moveTo(X_location_x - X_size, X_location_y + X_size);			
			context.lineTo(X_location_x + X_size, X_location_y - X_size);
			context.stroke();
		}

		function drawMap()
		{
			map_image = new Image();
			map_image.src = 'maps/1003/img.jpg';
			map_image.onload = function() {
				canvas = document.getElementById("map_canvas"),
				context = canvas.getContext('2d');
				canvas.width  = map_image.width;
				canvas.height = map_image.height;
				context.drawImage(map_image, 0, 0);
				postInit();
			}
		}

		function toRadians (angle) {
			return angle * (Math.PI / 180);
		}
		
		function toDegrees (angle) {
			return angle * (180 / Math.PI);
		}

		function prepareOrientationData() {
			console.log("prepareOrientationData()");
			mapOrientData.vector = calcGeoVector(mapOrientData.p1.lat, mapOrientData.p1.lon, mapOrientData.p2.lat, mapOrientData.p2.lon);
			var xyDist = distance(0, 0, map_image.width, map_image.height);
			mapOrientData.vectorRatio = xyDist / mapOrientData.vector.dist
			console.log("mapOrientData:" + JSON.stringify(mapOrientData));			
		}

		function distance(x1, y1, x2, y2) {			
			var distX = x2 - x1;
			var distY = y2 - y1;
			var dist = Math.sqrt(distX * distX + distY * distY);
			console.log("distX: " + distX + ", distY: " + distY + ", dist: " + dist);
			return dist;
		}

		function angleFromEast(lat1, lon1, lat2, lon2, dist) {
			var distOverLat = getDistanceFromLatLonInKm(lat1, lon1, lat2, lon1);			
			var angle = Math.asin(distOverLat/dist);
			console.log("Angle: Rad=" + angle + ", Deg=" + toDegrees(angle));	
			return angle;
		}

		function calcGeoVector(lat1, lon1, lat2, lon2) {
			console.log("calcGeoVector: #1:" + lat1 + ", " + lon1 + " #2:" + lat2 + ", " + lon2);			
			var vector = {angle: 0.0, dist: 0.0};									 						
			vector.dist = getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2);
			vector.angle = angleFromEast(lat1, lon1, lat2, lon2, vector.dist);
			console.log("vector: " + JSON.stringify(vector));
			return vector;
		}

		function latLon_2_xy(lat, lon) {
			var p = {x: 0.0, y: 0.0};
			console.log("latLon_2_xy: lat:" + lat + ", " + lon);
			var vector = calcGeoVector(mapOrientData.p1.lat, mapOrientData.p1.lon, lat, lon);
			// Assuming the top left corner of the image is 0,0 and the bottom right corner is the "100,100":
			angleDelta = mapOrientData.vector.angle - vector.angle;
			angle = mapOrientData.vector.angle - angleDelta;
			dist = vector.dist * mapOrientData.vectorRatio;
			console.log("dist: " + dist + ", angle:" + angle);

			p.x = Math.cos(angle) * dist;
			p.y = Math.sin(angle) * dist;
			console.log("p.x: " + p.x + ", p.y:" + p.y);

			return p;
		}

		// From StackOverFlow:
		// https://stackoverflow.com/questions/27928/calculate-distance-between-two-latitude-longitude-points-haversine-formula
		function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
  		var R = 6371; // Radius of the earth in km
  		var dLat = toRadians(lat2-lat1);  // deg2rad below
  		var dLon = toRadians(lon2-lon1); 
  		var a = 
    		Math.sin(dLat/2) * Math.sin(dLat/2) +
    		Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) * 
    		Math.sin(dLon/2) * Math.sin(dLon/2); 
  		var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
			var d = R * c; // Distance in km
			console.log("getDistanceFromLatLonInKm: " + d);
  		return d;
		}

		function setMapOrientData() {				
			var dataJson = 
			/* 1002: Full Israel: *///{"ver":1,"ori_point_left_top_lat":"33.6389522","ori_point_left_top_long":"33.2235350","ori_point_right_bottom_lat":"29.0940005","ori_point_right_bottom_long":"36.8380370"};
			/* 1003: Road 1-443: */ {"ver":1,"ori_point_left_top_lat":"32.0476788","ori_point_left_top_long":"34.7729125","ori_point_right_bottom_lat":"31.6918620","ori_point_right_bottom_long":"35.3702941"};
			/* 1004: Australia Kalinburu:*/// {"ver":1,"ori_point_left_top_lat":"-14.2825752","ori_point_left_top_long":"126.6229404","ori_point_right_bottom_lat":"-14.3016826","ori_point_right_bottom_long":"126.6543544"};
			/* Street corner: */// testPoint = [-14.293615, 126.644603];
			/* 1005: Santiago: */ //{"ver":1,"ori_point_left_top_lat":"-33.2970122","ori_point_left_top_long":"-70.8912797","ori_point_right_bottom_lat":"-33.5966048","ori_point_right_bottom_long":"-70.2980180"};
			/* Pudahel street: */ //testPoint = [-33.447511, -70.777573];	
			/* 1006: NY: */ //{"ver":1,"ori_point_left_top_lat":"40.7533338","ori_point_left_top_long":"-74.2577155","ori_point_right_bottom_lat":"40.5209412","ori_point_right_bottom_long":"-73.8127692"};
			/* Verezano Bridge: */ //testPoint = [40.607508, -74.044776];		

			mapOrientData.p1.lat = dataJson.ori_point_left_top_lat;
			mapOrientData.p1.lon = dataJson.ori_point_left_top_long;
			mapOrientData.p2.lat = dataJson.ori_point_right_bottom_lat;
			mapOrientData.p2.lon = dataJson.ori_point_right_bottom_long;
		}

		function postInit() { // Runs after image loads:
			console.log("postInit...");
			prepareOrientationData();
			initiate_watchlocation();
		}

		function init() {
			console.log("init...");
			setMapOrientData();			
			drawMap();
		}
		
		window.onload = init;
    </script>
  </head>
  <body>
    <div>	  
		<button type="button" onclick="initiate_watchlocation();">Start Position</button>
		&nbsp&nbsp
		<button type="button" onclick="stop_watchlocation();">Stop Position</button>
		&nbsp&nbsp
		<button type="button" onclick="getLocation();">Get Location</button>
		&nbsp&nbsp
		<input type="text" id="info" name="info">	  
		&nbsp&nbsp
		<button type="button" onclick="applyLocation();">Apply Location</button>
		&nbsp&nbsp
		<input type="text" id="newLoc" name="newLoc">	  
    </div>
	<canvas id="map_canvas" name="map_canvas"></canvas>
  </body>
</html>